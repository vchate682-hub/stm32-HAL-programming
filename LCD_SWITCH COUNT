#include "stm32f4xx_hal.h"
#include <stdint.h>

/***********************************************************
 *    PROGRAM MACROS DEFINITIONS
 ***********************************************************/
#define BUZZER_PORT GPIOB
#define BUZZER_PIN  GPIO_PIN_4
#define SW_PORT     GPIOB
#define SW_PIN      GPIO_PIN_1

/***************************************************
 *  VARIABLE DECLARATION
 ***************************************************/
volatile uint8_t count = 0;
volatile uint8_t flag = 0;

/*********************************************************************
 *   GPIO PIN AND SWITCH Initialization Function
 *********************************************************************/
static void GPIO_Init(void)
{
    GPIO_InitTypeDef GPIO_InitStruct = {0};

    __HAL_RCC_GPIOB_CLK_ENABLE();
    __HAL_RCC_SYSCFG_CLK_ENABLE();

    HAL_GPIO_WritePin(BUZZER_PORT, BUZZER_PIN, GPIO_PIN_RESET);

    /***************************************
     * Configure GPIO pin : PB1 (Switch)
     ***************************************/
    GPIO_InitStruct.Pin = SW_PIN;
    GPIO_InitStruct.Mode = GPIO_MODE_IT_FALLING;
    GPIO_InitStruct.Pull = GPIO_PULLUP;
    HAL_GPIO_Init(SW_PORT, &GPIO_InitStruct);

    /*****************************************
     * Configure GPIO pin : PB4 (Buzzer)
     *****************************************/
    GPIO_InitStruct.Pin = BUZZER_PIN;
    GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
    GPIO_InitStruct.Pull = GPIO_NOPULL;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
    HAL_GPIO_Init(BUZZER_PORT, &GPIO_InitStruct);

    /********************************************************
     *     INTERRUPT ENABLE
     ********************************************************/
    HAL_NVIC_SetPriorityGrouping(NVIC_PRIORITYGROUP_4);
    HAL_NVIC_SetPriority(EXTI1_IRQn, 1, 0);
    HAL_NVIC_EnableIRQ(EXTI1_IRQn);
}

/*************************************************************
 *    CALLBACK FUNCTION
 *************************************************************/
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
    if (GPIO_Pin == SW_PIN)
    {
        static uint32_t last_count = 0;
        if (HAL_GetTick() - last_count > 200) // debounce
        {
            count++;
            flag = 1;
            last_count = HAL_GetTick();
        }
    }
}

/***********************************************************************
 *       EXTI1_IRQHandler
 ***********************************************************************/
void EXTI1_IRQHandler(void)
{
    HAL_GPIO_EXTI_IRQHandler(SW_PIN);
}

/****************************************************************
 *      MAIN FUNCTION
 ****************************************************************/
int main(void)
{
    HAL_Init();
    GPIO_Init();

    while (1)
    {
        if (flag)
        {
            for (int i = 0; i < count; i++)
            {
                HAL_GPIO_WritePin(BUZZER_PORT, BUZZER_PIN, GPIO_PIN_SET);
                HAL_Delay(200);
                HAL_GPIO_WritePin(BUZZER_PORT, BUZZER_PIN, GPIO_PIN_RESET);
                HAL_Delay(200);
            }
            flag = 0;
        }
    }

    return 0;
}
